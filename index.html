<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="ka-min.png" type="image/png">
  <title>マンホールカード旅</title>
  <style>
    body { font-family: "Segoe UI", "Hiragino Sans", sans-serif; background:#fafafa; padding:20px; color:#333; }
    h2 { font-size:28px; font-weight:600; margin-bottom:10px; border-left:5px solid #1976d2; padding-left:12px; }
    #summary { margin-bottom:20px; font-size:18px; font-weight:500; }
    select {
      padding: 8px 12px;
      font-size: 16px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    .table-wrapper { width:100%; overflow-x:auto; }

    table { border-collapse: collapse; width: 100%; min-width:700px; table-layout: fixed; }
    th, td { border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align: top; }
    th { background:#f0f0f0; }
    td a { color:#1976d2; text-decoration:none; }
    td a:hover { text-decoration:underline; }
    .done { color:#000; background:#aaa; }
    input[type="checkbox"] { transform: scale(1.2); }

    /* 列幅 */
    th:nth-child(1), td:nth-child(1) { width:10px; }
    th:nth-child(2), td:nth-child(2) { width:50px; }
    th:nth-child(3), td:nth-child(3) { width:50px; }
    th:nth-child(4), td:nth-child(4) { width:70px; }
    th:nth-child(5), td:nth-child(5) { width:70px; }
    th:nth-child(6), td:nth-child(6) { width:180px; }
    th:nth-child(7), td:nth-child(7) { width:250px; }
    th:nth-child(8), td:nth-child(8) { width:50px; }

    .mhcard-link-distance {
      font-size:14px;
      margin-top:10px;
      margin-bottom:20px;
    }
    .mhcard-link-distance a {
      color:#1976d2;
      font-weight:bold;
      text-decoration:none;
    }
    .mhcard-link-distance a:hover {
      text-decoration:underline;
    }

    @media (max-width: 768px) {
      body { padding:10px; }
      h2 { font-size:22px; }
      table { min-width:600px; }
      th, td { font-size:14px; padding:4px 6px; }
    }
  </style>
</head>
<body>

<h2>
  <img src="ka-min.png" alt="カーミン" style="width:1em; height:auto; vertical-align:text-bottom; margin-right:0.3em;">
  マンホールカード旅
</h2>

<div class="mhcard-link-distance">
  詳しくは <a href="https://www.gk-p.jp/mhcard/" target="_blank">マンホールカード公式サイト</a> をご確認ください。
</div>

<select id="trip-select"><option value="">旅行を選択</option></select>
<div id="summary"></div>
<div id="schedule-container"></div>


<script>
let trips = {};
let currentTrip = null;

// JSON読み込み
fetch("trip.json")
  .then(res => res.json())
  .then(data => {
    trips = data;
    const select = document.getElementById("trip-select");

    const names = Object.keys(trips)
      .sort((a,b) => new Date(b.split(" ")[0]) - new Date(a.split(" ")[0]));

    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });

    if(names.length > 0){
      currentTrip = names[0];
      select.value = currentTrip;
      renderDays();
    }
  });

document.getElementById("trip-select").addEventListener("change", e => {
  currentTrip = e.target.value;
  renderDays();
});

function renderDays() {
  const container = document.getElementById("schedule-container");
  container.innerHTML = "";
  if (!currentTrip) return;

  const days = trips[currentTrip].days;
  const flatItems = [];
  days.forEach(dayData => dayData.forEach(item => flatItems.push(item)));

  // -------------------------------------------------
  // ★ 追加：総距離 & マンホールカード枚数 計算
  // -------------------------------------------------
  let totalDistance = 0;
  let cardCount = 0;

  flatItems.forEach(item => {
    // 距離（"12.3km" など → 数値へ）
    const d = parseFloat(item.distance);
    if (!isNaN(d)) totalDistance += d;

    // マンホールカード枚数（manhole_url が "-" 以外）
    if (item.manhole_url && item.manhole_url !== "-") {
      cardCount++;
    }
  });

  // summary に表示
    document.getElementById("summary").innerHTML =
    `総距離：${totalDistance.toFixed(1)} km<br>
    マンホールカード枚数：${cardCount} 枚`;


  // -------------------------------------------------

  days.forEach((dayData, idx) => {
    const dayTitle = document.createElement("h3");
    dayTitle.textContent = `【${idx+1}日目】`;
    container.appendChild(dayTitle);

    const wrapper = document.createElement("div");
    wrapper.className = "table-wrapper";

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `<tr>
      <th>完了</th>
      <th>出発</th>
      <th>到着</th>
      <th>距離</th>
      <th>市区町村</th>
      <th>目的地</th>
      <th>住所</th>
      <th>GKP</th>
    </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    table.appendChild(tbody);
    wrapper.appendChild(table);
    container.appendChild(wrapper);

    dayData.forEach(item => {
      const globalIndex = flatItems.indexOf(item);
      const tr = document.createElement("tr");
      if(item.done) tr.classList.add("done");

      tr.innerHTML = `
        <td><input type="checkbox" data-index="${globalIndex}" ${item.done?"checked":""}></td>
        <td>${item.departure}</td>
        <td>${item.arrival}</td>
        <td>${item.distance}</td>
        <td>${item.city || ""}</td>
        <td>
          ${item.url
            ? `<a href="${item.url}" target="_blank">${item.title}</a>`
            : item.title
          }
        </td>
        <td><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank">${item.address}</a></td>
        <td>${
        item.manhole_url && item.manhole_url !== "-" 
            ? `<a href="${item.manhole_url}" target="_blank">リンク</a>`
            : "-"
        }</td>
      `;
      tbody.appendChild(tr);
    });
  });

  attachEvents(flatItems);
}

function attachEvents(flatItems) {
  document.querySelectorAll("input[type='checkbox']").forEach(cb=>{
    cb.addEventListener("change",()=>{
      const idx = Number(cb.dataset.index);

      if(cb.checked){
        for(let i=0;i<=idx;i++) flatItems[i].done = true;
      } else {
        for(let i=idx;i<flatItems.length;i++) flatItems[i].done = false;
      }
      renderDays();
    });
  });
}
</script>

</body>
</html>

